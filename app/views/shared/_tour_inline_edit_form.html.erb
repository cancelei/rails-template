<%# locals: (tour:, form_url:, cancel_url:, show_advanced_fields: false) %>
<div class="card">
  <div class="card-body">
    <%= form_with model: tour, url: form_url, method: :patch, data: { turbo_frame: dom_id(tour) } do |f| %>
      <h3 class="text-xl font-semibold text-foreground mb-4">Edit Tour</h3>

      <% if tour.errors.any? %>
        <div class="alert alert-danger mb-4">
          <h4 class="font-semibold mb-2"><%= pluralize(tour.errors.count, "error") %> prevented this tour from being saved:</h4>
          <ul class="text-sm list-disc list-inside">
            <% tour.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="space-y-4">
        <div class="form-group">
          <%= f.label :title, class: "form-label form-label-required" %>
          <%= f.text_field :title, class: "form-input", required: true %>
        </div>

        <div class="form-group">
          <%= f.label :description, class: "form-label" %>
          <%= f.text_area :description, rows: 3, class: "form-input" %>
        </div>

        <div class="grid <%= show_advanced_fields ? 'grid-cols-3' : 'grid-cols-2' %> gap-4">
          <div class="form-group">
            <%= f.label :tour_type, class: "form-label" %>
            <%= f.select :tour_type,
                         Tour.tour_types.keys.map { |k| [k.titleize, k] },
                         {},
                         class: "form-input" %>
          </div>

          <div class="form-group">
            <%= f.label :status, class: "form-label" %>
            <%= f.select :status,
                         Tour.statuses.keys.map { |k| [k.titleize, k] },
                         {},
                         class: "form-input" %>
          </div>

          <div class="form-group">
            <%= f.label :capacity, "Max Capacity", class: "form-label form-label-required" %>
            <%= f.number_field :capacity, min: 1, class: "form-input", required: true %>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <%= f.label :price_cents, "Price (cents)", class: "form-label" %>
            <%= f.number_field :price_cents, min: 0, class: "form-input", placeholder: "e.g., 5000 for $50.00" %>
          </div>

          <% if show_advanced_fields %>
            <div class="form-group">
              <%= f.label :currency, class: "form-label" %>
              <%= f.text_field :currency, class: "form-input", placeholder: "USD" %>
            </div>
          <% end %>
        </div>

        <div class="form-group">
          <%= f.label :location_name, class: "form-label" %>
          <%= f.text_field :location_name, class: "form-input", placeholder: "e.g., Central Park, New York" %>
        </div>

        <% if show_advanced_fields %>
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <%= f.label :latitude, class: "form-label" %>
              <%= f.number_field :latitude, step: "any", class: "form-input", placeholder: "40.7829" %>
            </div>

            <div class="form-group">
              <%= f.label :longitude, class: "form-label" %>
              <%= f.number_field :longitude, step: "any", class: "form-input", placeholder: "-73.9654" %>
            </div>
          </div>
        <% end %>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <%= f.label :starts_at, "Start Date & Time", class: "form-label form-label-required" %>
            <%= f.datetime_local_field :starts_at, class: "form-input", required: true %>
          </div>

          <div class="form-group">
            <%= f.label :ends_at, "End Date & Time", class: "form-label form-label-required" %>
            <%= f.datetime_local_field :ends_at, class: "form-input", required: true %>
          </div>
        </div>

        <% if tour.private_tour? || f.object.private_tour? %>
          <div class="form-group">
            <%= f.label :booking_deadline_hours, "Booking Deadline", class: "form-label" %>
            <%= f.select :booking_deadline_hours,
                         Tour::BOOKING_DEADLINE_OPTIONS.map { |hours| ["#{hours} #{'hour'.pluralize(hours)} before start", hours] },
                         { include_blank: "Select deadline" },
                         class: "form-input" %>
            <p class="text-xs text-muted-foreground mt-1">Required for private tours</p>
          </div>
        <% end %>

        <div class="form-group">
          <%= f.label :cover_image, "Cover Image", class: "form-label" %>
          <% if tour.cover_image.attached? %>
            <div class="mb-2">
              <%= image_tag tour.cover_image.variant(resize_to_limit: [200, 150]), class: "rounded border" %>
            </div>
          <% end %>
          <%= f.file_field :cover_image, accept: "image/png,image/jpeg,image/jpg,image/webp", class: "form-input" %>
          <p class="text-xs text-muted-foreground mt-1">PNG, JPEG, or WEBP (max 5MB)</p>
        </div>

        <div class="flex gap-3 pt-4 border-t border-border">
          <%= f.submit "Save Changes", class: "btn-booking", data: { controller: "loading-state", action: "loading-state#showLoading" } %>
          <%= link_to "Cancel",
                      cancel_url,
                      class: "btn-booking-secondary",
                      data: { turbo_frame: dom_id(tour), turbo_action: "replace" } %>
        </div>
      </div>
    <% end %>
  </div>
</div>
